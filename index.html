<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cosmetics åŒ–å¦å“ç®¡å®¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg: #FFF9F9; --card: #FFFFFF; 
            --accent: #F2D1D1; --accent-dark: #E1AFAF;
            --text-main: #6D5D5D; --text-dim: #B9A8A8;
            --opened: #E2F0D9; --danger: #FF6B6B;
            --stats-bg: #FFF4E6;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 10px 15px 120px; font-weight: 300; }
        .brand-header { text-align: center; margin: 20px 0 15px; }
        h2 { font-family: 'Playfair Display', serif; font-weight: 600; letter-spacing: 4px; margin: 0; color: #5A4B4B; text-transform: uppercase; font-size: 24px; }
        .sub-title { font-size: 13px; color: var(--text-dim); letter-spacing: 2px; margin-top: 5px; display: block; }

        /* èªè­‰èˆ‡è¼¸å…¥æ¨£å¼ */
        .auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .auth-card { background: white; padding: 40px 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(242,209,209,0.3); width: 100%; max-width: 350px; }
        .hidden { display: none !important; }
        
        .input-group { width: 100%; margin-bottom: 5px; position: relative; }
        input, select { width: 100%; padding: 14px; margin: 8px 0 2px; background: #FFF9F9; border: 1px solid #FFE4E4; border-radius: 18px; box-sizing: border-box; font-size: 14px; color: var(--text-main); }
        
        .error-msg { color: var(--danger); font-size: 11px; margin-left: 10px; min-height: 15px; transition: 0.3s; opacity: 0; }
        .error-msg.show { opacity: 1; }

        .btn-dynamic { width: 100%; padding: 14px; background: #FCEAEA; color: #E1AFAF; border: none; border-radius: 18px; font-weight: 500; cursor: pointer; margin-top: 10px; }
        .btn-dynamic.ready { background: var(--accent-dark); color: white; }

        /* ä¸»ç•«é¢ */
        #app-screen { max-width: 500px; margin: 0 auto; }
        .filter-bar { display: flex; gap: 6px; padding: 10px 0 20px; width: 100%; }
        .filter-btn { flex: 1; text-align: center; padding: 10px 0; border-radius: 20px; background: #FFF; border: 1px solid #FFE4E4; color: var(--text-dim); font-size: 12px; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--accent-dark); color: white; }

        .card { background: var(--card); border-radius: 28px; padding: 20px; margin-bottom: 20px; position: relative; border: 1px solid #FFF0F0; box-shadow: 0 8px 20px rgba(242, 209, 209, 0.15); }
        .card-content { display: flex; gap: 18px; align-items: center; }
        .img-box { width: 85px; height: 85px; border-radius: 20px; background: #FFF5F5; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 1px solid #FFE4E4; flex-shrink: 0; }
        
        .stats-row { background: var(--stats-bg); margin-top: 12px; padding: 8px 15px; border-radius: 12px; display: flex; justify-content: space-between; font-size: 12px; color: #A67C52; }
        .timer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .timer-item { background: #FFFBFB; padding: 10px; border-radius: 14px; border: 1px solid #FFF2F2; text-align: center; font-size: 11px; }
        
        .btn-use { width: 100%; margin-top: 15px; padding: 12px; border: none; border-radius: 15px; font-weight: 500; cursor: pointer; background: var(--accent-dark); color: white; }
        .btn-sub { background: none; border: none; font-size: 12px; color: var(--text-dim); cursor: pointer; margin-top: 10px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(109, 93, 93, 0.3); backdrop-filter: blur(10px); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; padding: 30px; border-radius: 35px; }
        .fab { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); width: 200px; background: var(--accent-dark); color: white; padding: 18px; border-radius: 40px; text-align: center; font-weight: 500; cursor: pointer; box-shadow: 0 10px 30px rgba(225, 175, 175, 0.4); z-index: 100; }
        .status-badge { position: absolute; top: 20px; right: 20px; font-size: 10px; padding: 5px 12px; border-radius: 12px; font-weight: 500; }
        .status-opened { background: var(--opened); color: #769363; }
        .status-unopened { background: #F5F5F5; color: #AAA; }
    </style>
</head>
<body>

    <div id="login-screen" class="auth-screen">
        <div class="auth-card">
            <div class="brand-header"><h2>My Cosmetics</h2><span class="sub-title">åŒ–å¦å“ç®¡ç†</span></div>
            <div class="input-group">
                <input type="email" id="login-email" placeholder="Email" oninput="clearError('login-error')">
            </div>
            <div class="input-group">
                <input type="password" id="login-password" placeholder="å¯†ç¢¼" oninput="clearError('login-error')">
                <div id="login-error" class="error-msg">éŒ¯èª¤è¨Šæ¯</div>
            </div>
            <button class="btn-dynamic ready" onclick="handleAuth('login')">ç™»å…¥ç³»çµ±</button>
            <button class="btn-sub" style="width:100%" onclick="switchAuth('signup')">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </div>
    </div>

    <div id="signup-screen" class="auth-screen hidden">
        <div class="auth-card">
            <div class="brand-header"><h2>Create Account</h2><span class="sub-title">åŒ–å¦å“ç®¡ç†</span></div>
            <div class="input-group">
                <input type="email" id="reg-email" placeholder="Email" oninput="clearError('reg-error')">
            </div>
            <div class="input-group">
                <input type="password" id="reg-password" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)" oninput="clearError('reg-error')">
            </div>
            <div class="input-group">
                <input type="password" id="reg-confirm" placeholder="ç¢ºèªå¯†ç¢¼" oninput="clearError('reg-error')">
                <div id="reg-error" class="error-msg">éŒ¯èª¤è¨Šæ¯</div>
            </div>
            <button class="btn-dynamic ready" onclick="handleAuth('signup')">å®Œæˆè¨»å†Š</button>
            <button class="btn-sub" style="width:100%" onclick="switchAuth('login')">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 5px;">
            <span id="user-display" style="font-size: 11px; color: var(--text-dim);"></span>
            <button class="btn-sub" onclick="logout()" style="color: #FFB3B3;">ç™»å‡º</button>
        </div>
        <div class="brand-header"><h2>My Cosmetics</h2><span class="sub-title">åŒ–å¦å“ç®¡ç†</span></div>
        <input type="text" id="search-input" placeholder="æœå°‹ç”¢å“åç¨±..." oninput="render()">
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="setFilter('åº•å¦é¡', this)">åº•å¦é¡</button>
            <button class="filter-btn" onclick="setFilter('å½©å¦é¡', this)">å½©å¦é¡</button>
            <button class="filter-btn" onclick="setFilter('å…¶ä»–é¡', this)">å…¶ä»–é¡</button>
        </div>
        
        <div id="main-list"></div>
        <div class="fab" onclick="openPopup()">ï¼‹ æ–°å¢åŒ–å¦å“</div>
    </div>

    <div id="popup" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; color:#5A4B4B; margin-bottom:20px;">ç”¢å“ç´°ç¯€</h3>
            <div id="photo-preview" class="img-box" style="width:100%; height:160px; margin-bottom:15px; cursor:pointer;" onclick="document.getElementById('file-input').click()">
                <span id="photo-text">ğŸ“¸ é»æ“Šæ·»åŠ ç…§ç‰‡</span>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display: none" onchange="previewFile(this)">
            <input type="text" id="in-name" placeholder="ç”¢å“åç¨±*" oninput="checkSaveInputs()">
            
            <select id="in-cat">
                <optgroup label="åº•å¦é¡"><option value="å¦å‰">å¦å‰</option><option value="ç²‰åº•">ç²‰åº•</option><option value="å®šå¦">å®šå¦</option><option value="é®ç‘•">é®ç‘•</option></optgroup>
                <optgroup label="å½©å¦é¡"><option value="çœ‰éƒ¨">çœ‰éƒ¨</option><option value="çœ¼éƒ¨">çœ¼éƒ¨</option><option value="é °éƒ¨">é °éƒ¨</option><option value="å”‡éƒ¨">å”‡éƒ¨</option></optgroup>
                <optgroup label="å…¶ä»–é¡"><option value="å…¶ä»–">å…¶ä»–</option></optgroup>
            </select>
            
            <input type="text" id="in-loc" placeholder="å­˜æ”¾ä½ç½®">
            <input type="number" id="in-price" placeholder="è³¼è²·é‡‘é¡ (NTD)*" oninput="checkSaveInputs()">
            <label style="font-size: 11px; color: var(--text-dim); margin-top: 10px; display:block;">åŸå§‹ä¿å­˜æœŸé™*</label>
            <input type="date" id="in-exp" oninput="checkSaveInputs()">
            <input type="number" id="in-pao" placeholder="é–‹å°å¾Œæ•ˆæœŸ (æœˆæ•¸)*" oninput="checkSaveInputs()">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin:15px 5px;">
                <span style="font-size:14px;">æ­¤ç”¢å“å·²é–‹å°</span>
                <input type="checkbox" id="in-is-opened" style="width:20px; height:20px;" onchange="toggleOpenDateField()">
            </div>

            <div id="open-date-container" class="hidden">
                <label style="font-size: 11px; color: var(--text-dim); display:block;">é¸æ“‡é–‹å°æ—¥æœŸ</label>
                <input type="date" id="in-open-date">
            </div>

            <button id="btn-save" class="btn-dynamic" onclick="saveItem()">å„²å­˜</button>
            <button onclick="closePopup()" class="btn-sub" style="width:100%">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // Firebase è¨­å®šèˆ‡åˆå§‹åŒ–
        const firebaseConfig = {
            apiKey: "AIzaSyBSfNyw79pUK9fG07YA7BI1kpB8tpl4tB4",
            authDomain: "myvanity-a9d5a.firebaseapp.com",
            projectId: "myvanity-a9d5a",
            storageBucket: "myvanity-a9d5a.firebasestorage.app",
            messagingSenderId: "34232448278",
            appId: "1:34232448278:web:5ae98ee2a51580afd2cc37"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let vanityDb = [], curId = null, curBase64 = "", curFilter = "å…¨éƒ¨", currentUser = null;
        const categoryGroups = { 'åº•å¦é¡': ['å¦å‰', 'ç²‰åº•', 'å®šå¦', 'é®ç‘•'], 'å½©å¦é¡': ['çœ‰éƒ¨', 'çœ¼éƒ¨', 'é °éƒ¨', 'å”‡éƒ¨'], 'å…¶ä»–é¡': ['å…¶ä»–'] };

        // ç™»å…¥è¨»å†Šé‚è¼¯ (ä¿æŒä¸è®Š)
        function switchAuth(type) {
            clearError('login-error'); clearError('reg-error');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('signup-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById(`${type}-screen`).classList.remove('hidden');
        }
        function showError(elementId, message) { const errEl = document.getElementById(elementId); errEl.innerText = message; errEl.classList.add('show'); }
        function clearError(elementId) { const el = document.getElementById(elementId); if(el) el.classList.remove('show'); }
        async function handleAuth(type) {
            const errorId = type === 'login' ? 'login-error' : 'reg-error';
            const email = document.getElementById(type === 'login' ? 'login-email' : 'reg-email').value;
            const pass = document.getElementById(type === 'login' ? 'login-password' : 'reg-password').value;
            clearError(errorId);
            if (!email || !pass) { showError(errorId, "è«‹è¼¸å…¥å®Œæ•´çš„å¸³è™Ÿå¯†ç¢¼"); return; }
            if (type === 'signup') {
                const confirm = document.getElementById('reg-confirm').value;
                if (pass !== confirm) { showError(errorId, "å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´"); return; }
                if (pass.length < 6) { showError(errorId, "å¯†ç¢¼è‡³å°‘éœ€è¦ 6 ä½æ•¸"); return; }
            }
            try {
                if(type === 'signup') await auth.createUserWithEmailAndPassword(email, pass);
                else await auth.signInWithEmailAndPassword(email, pass);
            } catch(e) { 
                let msg = "";
                switch(e.code) {
                    case "auth/email-already-in-use": msg = "æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šé"; break;
                    case "auth/invalid-email": msg = "Email æ ¼å¼ä¸æ­£ç¢º"; break;
                    case "auth/user-not-found": msg = "å¸³è™Ÿä¸å­˜åœ¨"; break;
                    case "auth/wrong-password": msg = "å¯†ç¢¼éŒ¯èª¤"; break;
                    default: msg = "é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹";
                }
                showError(errorId, msg);
            }
        }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('signup-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.email;
                listenToData();
            } else { switchAuth('login'); }
        });

        function logout() { auth.signOut().then(() => { vanityDb = []; }); }
        function listenToData() {
            db.collection("users").doc(currentUser.uid).collection("items")
              .onSnapshot(snapshot => {
                  vanityDb = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  render();
              });
        }

        // æ–°å¢åŠŸèƒ½ï¼šæ§åˆ¶é–‹å°æ—¥æœŸè¼¸å…¥æ¡†é¡¯ç¤º
        function toggleOpenDateField() {
            const container = document.getElementById('open-date-container');
            const isChecked = document.getElementById('in-is-opened').checked;
            if (isChecked) {
                container.classList.remove('hidden');
                // å¦‚æœæ²’å¡«æ—¥æœŸï¼Œé è¨­ç‚ºä»Šå¤©
                if (!document.getElementById('in-open-date').value) {
                    document.getElementById('in-open-date').value = new Date().toISOString().split('T')[0];
                }
            } else {
                container.classList.add('hidden');
            }
        }

        function setFilter(f, btn) {
            curFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function render() {
            const list = document.getElementById('main-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';
            const now = new Date();
            
            vanityDb.filter(item => {
                const nameMatch = item.name.toLowerCase().includes(search);
                let catMatch = (curFilter === "å…¨éƒ¨") ? true : categoryGroups[curFilter].includes(item.cat);
                return nameMatch && catMatch;
            })
            .forEach(item => {
                const isOpened = !!item.openDate;
                const useCount = item.useCount || 0;
                const avgCost = useCount > 0 ? (item.price / useCount).toFixed(1) : item.price;
                const formatDate = (dateStr) => dateStr ? dateStr.replace(/-/g, '/') : 'æœªå¡«';
                const origExp = new Date(item.exp);
                
                let pDays = null;
                if (isOpened) {
                    // ä»¥ä¿å­˜çš„é–‹å°æ—¥æœŸè¨ˆç®— PAO
                    const openD = new Date(item.openDate);
                    const pDate = new Date(openD.setMonth(openD.getMonth() + parseInt(item.pao)));
                    pDays = Math.ceil((pDate - now) / 86400000);
                }
                const origDays = Math.ceil((origExp - now) / 86400000);

                list.innerHTML += `
                    <div class="card">
                        <span class="status-badge ${isOpened ? 'status-opened' : 'status-unopened'}">${isOpened ? 'å·²é–‹å°' : 'å…¨æ–°'}</span>
                        <div class="card-content">
                            <div class="img-box" style="background-image: url('${item.img || ''}')">${item.img ? '' : 'ğŸ’„'}</div>
                            <div style="flex-grow:1">
                                <div style="font-weight:500; font-size:16px;">${item.name}</div>
                                <div style="font-size:11px; color:var(--text-dim); margin-top:3px;">${item.cat} | ğŸ“ ${item.loc || 'æœªå¡«'}</div>
                                <div class="stats-row">
                                    <span>ä½¿ç”¨ <b>${useCount}</b> æ¬¡</span>
                                    <span>å–®æ¬¡ç´„ <b>$${avgCost}</b></span>
                                </div>
                                <div class="timer-grid">
                                    <div class="timer-item">
                                        <span style="font-size:9px">åˆ°æœŸæ—¥æœŸ</span><br>
                                        <b>${formatDate(item.exp)}</b>
                                    </div>
                                    <div class="timer-item">
                                        <span style="font-size:9px">${isOpened ? 'é–‹å°å¾Œå‰©é¤˜' : 'é›¢éæœŸå‰©é¤˜'}</span><br>
                                        <b style="${(isOpened ? pDays : origDays) < 90 ? 'color:var(--danger)' : ''}">${isOpened ? (pDays <= 0 ? 'å·²éæœŸ' : pDays + ' å¤©') : (origDays <= 0 ? 'å·²éæœŸ' : origDays + ' å¤©')}</b>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn-use ${isOpened ? '' : 'new-item'}" onclick="handleUseAction('${item.id}', ${isOpened}, ${useCount})">
                            ${isOpened ? "ï¼‹ è¨˜éŒ„ä¸€æ¬¡ä½¿ç”¨" : "âœ¨ é–‹å°ä¸¦è¨˜éŒ„ä½¿ç”¨"}
                        </button>
                        <div style="text-align:right">
                            <button class="btn-sub" onclick="openPopup('${item.id}')">ç·¨è¼¯</button>
                            <button class="btn-sub" style="color:var(--danger); margin-left:12px;" onclick="deleteItem('${item.id}')">åˆªé™¤</button>
                        </div>
                    </div>`;
            });
        }

        async function handleUseAction(id, isOpened, count) {
            if(!currentUser) return;
            const ref = db.collection("users").doc(currentUser.uid).collection("items").doc(id);
            if (!isOpened) {
                // å¦‚æœæ˜¯æŒ‰æŒ‰éˆ•é–‹å°ï¼Œé è¨­æ—¥æœŸç‚ºä»Šå¤©
                await ref.update({ openDate: new Date().toISOString().split('T')[0], useCount: 1 });
            } else {
                await ref.update({ useCount: (count || 0) + 1 });
            }
        }

        function checkSaveInputs() {
            const n = document.getElementById('in-name').value;
            const p = document.getElementById('in-price').value;
            const e = document.getElementById('in-exp').value;
            const pao = document.getElementById('in-pao').value;
            document.getElementById('btn-save').classList.toggle('ready', !!(n && p && e && pao));
        }

        function openPopup(id = null) {
            curId = id; document.getElementById('popup').style.display = 'flex';
            const item = id ? vanityDb.find(v => v.id === id) : null;
            document.getElementById('in-name').value = item?.name || "";
            document.getElementById('in-price').value = item?.price || "";
            document.getElementById('in-exp').value = item?.exp || "";
            document.getElementById('in-pao').value = item?.pao || "";
            document.getElementById('in-cat').value = item?.cat || "å¦å‰";
            document.getElementById('in-loc').value = item?.loc || "";
            
            const isOpened = !!item?.openDate;
            document.getElementById('in-is-opened').checked = isOpened;
            document.getElementById('in-open-date').value = item?.openDate ? item.openDate.split('T')[0] : "";
            
            curBase64 = item?.img || "";
            updatePreview(); 
            toggleOpenDateField(); // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡æ¡†é¡¯ç¤ºç‹€æ…‹
            checkSaveInputs();
        }

        function saveItem() {
            if(!document.getElementById('btn-save').classList.contains('ready')) return;
            const isOpened = document.getElementById('in-is-opened').checked;
            const openDateVal = document.getElementById('in-open-date').value;
            const itemInDb = curId ? vanityDb.find(v=>v.id===curId) : null;
            
            const data = {
                name: document.getElementById('in-name').value,
                price: parseFloat(document.getElementById('in-price').value),
                exp: document.getElementById('in-exp').value,
                pao: document.getElementById('in-pao').value,
                cat: document.getElementById('in-cat').value,
                loc: document.getElementById('in-loc').value,
                img: curBase64,
                // å¦‚æœå‹¾é¸é–‹å°ï¼Œå‰‡ä¿å­˜é¸æ“‡çš„æ—¥æœŸ
                openDate: isOpened ? openDateVal : null,
                useCount: itemInDb ? (itemInDb.useCount || 0) : 0
            };
            db.collection("users").doc(currentUser.uid).collection("items").doc(curId || undefined).set(data, {merge: true});
            closePopup();
        }

        function previewFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => { curBase64 = e.target.result; updatePreview(); };
            if(input.files[0]) reader.readAsDataURL(input.files[0]);
        }
        function updatePreview() {
            const p = document.getElementById('photo-preview');
            p.style.backgroundImage = curBase64 ? `url('${curBase64}')` : 'none';
            document.getElementById('photo-text').style.display = curBase64 ? 'none' : 'block';
        }
        function closePopup() { document.getElementById('popup').style.display = 'none'; }
        async function deleteItem(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.collection("users").doc(currentUser.uid).collection("items").doc(id).delete(); }
    </script>
</body>
</html>

